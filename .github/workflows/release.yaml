name: WASudoku Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  prepare:
    name: Prepare environment
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.read_tag.outputs.tag }}
    steps:
      - name: Run actions/checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >>"${GITHUB_OUTPUT}"
      - id: read_tag
        run: echo "tag=$(cat .github/VERSION)" >>"${GITHUB_OUTPUT}"

  build-web:
    name: Build web app
    runs-on: ubuntu-latest
    needs: prepare
    container:
      image: h3nc4/wasudoku-ci:${{ needs.prepare.outputs.tag }}
    steps:
      - name: Run actions/checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - run: scripts/version.sh "v${{ needs.prepare.outputs.version }}"
      - name: Get npm cache directory
        id: npm-cache-dir
        run: echo "dir=$(npm config get cache)" >>"${GITHUB_OUTPUT}"
      - name: Run actions/cache
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5
        with:
          path: ${{ steps.npm-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      - run: npm ci
      - run: npm run build
      - name: Package artifact
        run: |
          tar -czvf WASudoku.tar.gz -C dist .
          XZ_OPT=-9e tar -cJf WASudoku.tar.xz -C dist .
      - name: Run actions/upload-artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: gz-build
          path: WASudoku.tar.gz
          retention-days: 1
      - name: Run actions/upload-artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: xz-build
          path: WASudoku.tar.xz
          retention-days: 1
      - name: Create Pages artifact tar
        run: tar --format=ustar --no-same-owner -cf artifact.tar -C dist .
      - name: Run actions/upload-artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: github-pages
          path: artifact.tar

  deploy-pages:
    name: Deploy to GitHub Pages
    needs: build-web
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Run actions/deploy-pages
        id: deployment
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4

  build-apk:
    name: Build Android APK
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Run actions/checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Restore keystore
        run: echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 --decode >android.keystore
      - name: Add Android licenses
        run: |
          mkdir -p licenses
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" >>licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >>licenses/android-sdk-license
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >>licenses/android-sdk-license
          echo "84831b9409646a918e30573bab4c9c91346d8abd" >>licenses/android-sdk-preview-license
      - name: Build APK with Bubblewrap
        run: |
          docker run \
            --rm \
            --entrypoint sh \
            -e "BUBBLEWRAP_KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" \
            -e "BUBBLEWRAP_KEY_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" \
            -e "VERSION=${{ needs.prepare.outputs.version }}" \
            -v "${PWD}:/app" \
            ghcr.io/googlechromelabs/bubblewrap:1.24.1 \
            -c 'printf "%s\n" "${VERSION}" | bubblewrap update && yes | bubblewrap build'
          mv app-release-signed.apk WASudoku.apk
      - name: Run actions/upload-artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: apk
          path: WASudoku.apk
          retention-days: 1

  publish-image:
    name: Build and Push Runtime Image
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Run actions/checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Run docker/setup-buildx-action
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
      - name: Run docker/login-action
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Get build date
        id: build_date
        run: echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >>"${GITHUB_OUTPUT}"
      - name: Run docker/build-push-action
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ vars.DOCKERHUB_USERNAME }}/wasudoku:${{ needs.prepare.outputs.version }}
            ${{ vars.DOCKERHUB_USERNAME }}/wasudoku:latest
          build-args: |
            CI_IMAGE_TAG=${{ needs.prepare.outputs.tag }}
            VERSION=${{ needs.prepare.outputs.version }}
            COMMIT_SHA=${{ github.sha }}
            BUILD_DATE=${{ steps.build_date.outputs.date }}

  release:
    name: Publish GitHub Release
    needs: [build-web, build-apk, publish-image]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Run actions/download-artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: gz-build
      - name: Run actions/download-artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: xz-build
      - name: Run actions/download-artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: apk
      - name: Run softprops/action-gh-release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            WASudoku.tar.gz
            WASudoku.tar.xz
            WASudoku.apk
